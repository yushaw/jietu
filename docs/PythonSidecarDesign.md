# Python LangGraph Sidecar Design

This document captures the proposed Python sidecar module that augments SnapDescribe with LangGraph-based agent orchestration and optional local model support. The module is designed as a standalone, reusable runtime so that other applications in the ecosystem can reuse the same agent capabilities without duplicating stacks.

## Objectives
- Keep the Avalonia/.NET client responsible for capture, OCR, settings, localization, auditing, and tool execution.
- Introduce a detachable Python runtime that delivers rich agent coordination (LangGraph, LangChain ecosystem) while preserving determinism and safety requirements outlined in `agents.md`.
- Allow on-demand installation from GitHub Releases so that the base installer remains lightweight.
- Provide a stable, app-agnostic interface so additional desktop or service workloads can invoke the sidecar through the same contracts.

## High-Level Architecture
1. **UI & Host (SnapDescribe.App / other clients)**  
   - Builds the conversation context, exposes local resources (images, OCR text, prompts), and renders results.  
   - Owns all tool execution (`ShellAgentToolRunner`) to enforce white-listing, timeouts, and logging.  
   - Talks to the sidecar over a local RPC channel (gRPC/HTTP over Named Pipe) and persists transcripts in existing data structures.
2. **Python Sidecar (LangGraph runtime)**  
   - Runs LangGraph workflows that encapsulate agent logic, memory, and tool planning.  
   - Issues declarative action requests back to any connected host (e.g. `CallTool`, `RetrieveContext`, `AskUser`) and consumes structured responses.  
   - Abstracts model backends (remote APIs, Ollama, vLLM) behind a unified interface.

> The sidecar should run as a system-wide service (per-user) with client-specific sessions, so other first-party apps can connect by speaking the same protocol once they obtain the shared authentication token.

## Shared Runtime Requirements
- A single sidecar instance may serve multiple client applications. Each `StartRun` specifies `clientId` and `sessionId` to keep logs/telemetry isolated.
- The manifest and installer must document the public RPC contract (OpenAPI/gRPC proto) to allow external consumers to generate clients.
- Authentication keys are generated by the owner application (e.g. SnapDescribe) and stored in `%LOCALAPPDATA%\SnapDescribe\sidecar\tokens.json`. Other apps can request delegated tokens via an out-of-band provisioning flow.
- Provide semantic versioning (`major.minor.patch`) for the RPC API. Breaking changes bump the major version and require a new endpoint path.
- Publish SDK stubs (C#, TypeScript) that wrap the contract and handle token management so future apps can integrate with minimal boilerplate.

## Communication Contract
- Messages carry `runId`, `recordId`, `agentProfileId`, `step`, and a monotonic sequence ID for deterministic replay.
- Include `clientId` + `sessionId` for multi-application isolation and `capabilities` to advertise host-side tool availability.
- Core verbs:
  - `StartRun` / `ContinueRun`: host → sidecar, includes serialized conversation history, tool metadata, and runtime options.
  - `AgentEvent`: sidecar → host, delivering partial thoughts, tool action requests, or completion.
  - `ToolResult`: host → sidecar, delivering stdout/stderr/exitCode after the host executes a tool.
  - `CancelRun`: host → sidecar, triggered by the user; sidecar must unwind outstanding tasks.
- Transport options:  
  - Windows named pipe with length-prefixed JSON (simple, offline friendly).  
  - HTTP loopback (127.0.0.1) with mutual auth token (straightforward for reuse by diagnostics).  
  - gRPC if strong typing and streaming are desired.  
  The initial implementation can start with HTTP and migrate later.

## Packaging Strategy
- Produce an embedded CPython 3.11 environment (no Tk/idle) plus `langgraph`, `langchain`, and minimal dependencies (~70 MB unpacked).  
- Bundle the code as `snapdescribe-sidecar-win64.zip` with:
  - `python/` directory (runtime)
  - `sidecar/` package (LangGraph graph definitions, entrypoint)
  - `requirements.txt` / `constraints.txt`
  - `manifest.json` containing version, build time, SHA256
- Publish the zip on GitHub Releases alongside the main installer. Each release tag should include:
  - `SnapDescribeSetup.exe` / portable zip (current artifacts)
  - `snapdescribe-sidecar-win64.zip`
- Document the public RPC schema (OpenAPI/Proto files) within the release so downstream applications can pin against the same version.

## Installation & Updates
1. SnapDescribe checks the manifest URL (`https://github.com/yushaw/jietu/releases/latest/download/sidecar-manifest.json` or per-version endpoint). Other apps can reuse the same manifest.
2. If the sidecar is absent or outdated, the Agent Settings tab prompts the user with size, version, and changelog summary.
3. After user confirmation:
   - Download `zip` → verify SHA256 → extract to `%LOCALAPPDATA%\SnapDescribe\sidecar\python\<version>\`.
   - Write `sidecar-info.json` containing version, install path, and manifest hash.
4. On app launch and before each agent run, the host validates that the directory exists and `entrypoint.py` is runnable.
5. Updates follow the same flow; old versions can be retained (for rollback) or pruned.

## Host Integration Checklist
- [ ] Extend `AgentSettings` with sidecar configuration (`IsSidecarInstalled`, `SidecarPath`, `SidecarVersion`, `AutoUpdate`, `CustomEndpoint`).
- [ ] Add settings panel UI for install/update/remove controls with localized strings (`Agent.Sidecar.*`).
- [ ] Replace `AgentExecutionService` internals with an RPC client:
  - Build payloads from `CaptureRecord` and `AgentProfile`.
  - Stream tool requests/results between the host and sidecar.
  - Surface progress states in the UI (`Status.AgentInProgress`, step logs).
- [ ] Manage the sidecar lifecycle in `App.axaml.cs`:
  - Spawn the Python process on demand.
  - Monitor stdout/stderr for diagnostics.
  - Dispose/cancel on app shutdown.
- [ ] Persist sidecar telemetry (install success/failure, version) via `DiagnosticLogger` for supportability.
- [ ] Expose a lightweight .NET/TypeScript SDK that wraps the RPC contract and token exchange so additional clients can integrate without reimplementing the protocol.

## Sidecar Implementation Tasks
- [ ] Create a LangGraph graph module that maps SnapDescribe Agent Profiles to graph templates.
- [ ] Implement a server wrapper (FastAPI/Uvicorn or uvicorn + bare ASGI) handling `/runs` and `/tool-result`.
- [ ] Implement tool callback serialization (JSON schema, error codes).
- [ ] Provide unit tests (pytest) for run lifecycle, cancellation, tool error handling, and serialization determinism.
- [ ] Add a CLI entrypoint `python -m sidecar` for local smoke tests and future automation.
- [ ] Publish official protocol definitions (OpenAPI/Proto) and sample clients to support cross-application consumers.

## Security & Compliance
- Tool execution remains in the host; the sidecar never spawns arbitrary processes.
- Authentication:
  - During handshake, the host shares a random session token; all subsequent calls must include the token.
  - Deny requests without a valid token and log attempts.
- Network isolation:
  - Sidecar respects SnapDescribe offline mode (configuration flag); disable outbound HTTP when offline is enforced.
  - Expose a configuration flag to restrict accessible model endpoints or proxy settings.
- Logging:
  - Redact sensitive data (API keys, absolute paths) before persisting or sending back to the UI.
  - Provide trace IDs so that host logs and sidecar logs can be correlated.

## Testing Strategy
- **Unit**: pytest for LangGraph components, tool callback handlers, config parsing.
- **Integration**:  
  - Local harness that spins up sidecar, runs canned conversations, asserts deterministic transcripts.  
  - .NET tests mocking the RPC interface to cover error handling paths.
- **CI/CD**:
  - Build GitHub workflow to install Python, run `pytest`, package the zip, publish artifacts.
  - Update the main pipeline to consume the latest sidecar artifact and validate manifest integrity.

## Future Enhancements
- MCP adapters: register through the sidecar with shared settings, enabling external protocol bridges as described in `agents.md`.
- Local model adapters: integrate Ollama/vLLM clients within the sidecar while keeping the host agnostic.
- Rich local tool catalog: expose registration APIs so the host can surface additional Windows CLI/scripts, internal REST endpoints, or cached resources as LangGraph tools at runtime.
- Multi-agent orchestration: allow users to compose and nest Agent Profiles, dynamically sharing tool registries across runs.
- Workflow authoring: after the foundational sidecar is stable, build a LangGraph-based workflow designer (parallel/conditional steps, human-in-the-loop checkpoints) driven from the Avalonia UI.
- Observability: add structured traces (OpenTelemetry/JSONL) for replay and debugging.
- Hot reload & dev mode: allow developers to point SnapDescribe at a custom sidecar path for rapid iteration.
